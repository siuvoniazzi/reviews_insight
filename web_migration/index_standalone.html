<!DOCTYPE html>
<html class="scroll-smooth" lang="de">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Modern App Review Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Material+Icons+Round&amp;display=swap"
        rel="stylesheet" />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#E30613", // Visana Red
                        "background-light": "#F8FAFC",
                        "background-dark": "#0F172A",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.75rem",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .material-icons-round {
            vertical-align: middle;
            font-size: 1.25rem;
        }

        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex">
    <!-- Sidebar -->
    <aside
        class="w-64 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hidden lg:flex flex-col sticky top-0 h-screen">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white">
                <span class="material-icons-round">analytics</span>
            </div>
            <span class="font-bold text-xl tracking-tight">ReviewAI</span>
        </div>
        <nav class="flex-1 px-4 space-y-1 mt-4">
            <a class="flex items-center gap-3 px-4 py-3 bg-slate-100 dark:bg-slate-800 text-primary dark:text-white rounded-xl font-medium cursor-pointer"
                id="nav-dashboard">
                <span class="material-icons-round">dashboard</span> Dashboard
            </a>
            <div class="mt-8 px-4">
                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Apps</p>
                <div class="space-y-1">
                    <button id="btn-select-app-a"
                        class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 transition-colors">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span id="label-app-a-name">App A</span>
                    </button>
                    <button id="btn-select-app-b"
                        class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 transition-colors">
                        <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                        <span id="label-app-b-name">App B</span>
                    </button>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <header class="h-16 bg-primary text-white shadow-md sticky top-0 z-10 px-8 flex items-center justify-between">
            <h1 class="text-lg font-bold" id="header-title">Analyse: -</h1>
            <div class="flex items-center gap-4">
                <button class="p-2 hover:bg-white/20 rounded-full transition-colors"
                    onclick="document.documentElement.classList.toggle('dark')">
                    <span class="material-icons-round dark:hidden" style="color: white;">dark_mode</span>
                    <span class="material-icons-round hidden dark:block" style="color: white;">light_mode</span>
                </button>
                <button id="btn-refresh" title="Daten neu laden"
                    class="p-2 hover:bg-white/20 rounded-full transition-colors text-white">
                    <span class="material-icons-round">refresh</span>
                </button>
                <button id="btn-export-csv" title="Reviews als CSV exportieren"
                    class="p-2 hover:bg-white/20 rounded-full transition-colors text-white">
                    <span class="material-icons-round">download</span>
                </button>
                <button id="btn-header-settings"
                    class="flex items-center gap-2 px-4 py-2 bg-white text-primary font-bold rounded-lg hover:bg-slate-100 transition-colors shadow-sm">
                    <span class="material-icons-round text-base">settings</span>
                    <span class="hidden sm:inline">Einstellungen</span>
                </button>
            </div>
        </header>

        <div class="px-16 py-8 mx-auto space-y-8">
            <section>
                <div class="flex items-baseline gap-3 mb-2 flex-wrap">
                    <h2 class="text-3xl font-bold tracking-tight">Gemini Insights Comparison</h2>
                    <span class="text-slate-500 text-sm font-normal" id="last-updated">Aktualisiert: nie</span>
                    <button id="btn-export-img-insights"
                        class="hidden px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400 font-medium transition-colors ml-4 flex items-center gap-1">
                        <span class="material-icons-round text-sm">content_copy</span> Insights kopieren
                    </button>
                    <button id="btn-export-img-topics"
                        class="hidden px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400 font-medium transition-colors ml-2 flex items-center gap-1">
                        <span class="material-icons-round text-sm">content_copy</span> Topics kopieren
                    </button>
                </div>
                <p class="text-slate-600 dark:text-slate-400 max-w-3xl">Detaillierte KI-gest√ºtzte Analyse der
                    App-Store-Bewertungen.</p>
            </section>



            <div id="dashboard-content" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <!-- Apple Card -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden flex flex-col">
                    <div
                        class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-800/30">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üçé</span>
                            <h3 class="font-bold text-lg">Apple App Store</h3>
                        </div>
                        <div class="flex items-center gap-4">
                            <span id="apple-verdict-badge"
                                class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-1"></span>
                            <button id="btn-fetch-apple"
                                class="flex items-center gap-2 px-3 py-1.5 bg-primary hover:bg-red-700 text-white rounded-lg text-xs font-bold transition-colors shadow-sm">
                                <span class="material-icons-round text-sm">download</span>
                                Reviews abrufen
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Google Card -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden flex flex-col">
                    <div
                        class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-800/30">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">‚ñ∂Ô∏è</span>
                            <h3 class="font-bold text-lg">Google Play Store</h3>
                        </div>
                        <div class="flex items-center gap-4">
                            <span id="google-verdict-badge"
                                class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-1"></span>
                            <input type="file" id="input-google-csv-card" accept=".csv" multiple class="hidden">
                            <button id="btn-upload-google"
                                class="flex items-center gap-2 px-3 py-1.5 bg-primary hover:bg-red-700 text-white rounded-lg text-xs font-bold transition-colors shadow-sm">
                                <span class="material-icons-round text-sm">upload_file</span>
                                CSV Upload
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Analysis Date Range Selector (shown after data is loaded) -->
            <section id="analysis-date-controls"
                class="hidden p-6 bg-slate-50 dark:bg-slate-800 rounded-2xl mb-6 border border-slate-200 dark:border-slate-700">
                <div class="flex flex-col md:flex-row md:items-end gap-6">
                    <div class="flex-grow">
                        <h3 class="font-bold mb-4 flex items-center gap-2">
                            <span class="material-icons-round text-slate-500">date_range</span>
                            Analyse-Zeitraum
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">Von</label>
                                <input type="date" id="analysis-date-from"
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary text-sm dark:bg-slate-700 dark:border-slate-600 p-2">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">Bis</label>
                                <input type="date" id="analysis-date-to"
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary text-sm dark:bg-slate-700 dark:border-slate-600 p-2">
                            </div>
                        </div>
                        <div class="mt-4 flex gap-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <div id="stats-apple"
                                class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                <span class="text-lg">üçé</span> <span class="font-bold">-</span> √ò
                            </div>
                            <div id="stats-google"
                                class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                <span class="text-lg">‚ñ∂Ô∏è</span> <span class="font-bold">-</span> √ò
                            </div>
                        </div>
                    </div>
                    <div class="md:w-1/3">
                        <div id="date-range-warnings"
                            class="text-xs text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg hidden">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analysis Mode Selector (shown after data is loaded) -->
            <section id="analysis-mode-selector" class="hidden">
                <h3 class="text-xl font-bold mb-4">Analyse-Modus w√§hlen:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="btn-insights-mode"
                        class="p-6 border-2 border-slate-300 dark:border-slate-700 hover:border-primary dark:hover:border-primary rounded-2xl transition-all text-left">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">üìä</span>
                            <h4 class="text-lg font-bold">Insights erstellen</h4>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400">Sentiment-Analyse, Pros/Cons, Empfehlungen
                        </p>
                    </button>
                    <button id="btn-topics-mode"
                        class="p-6 border-2 border-slate-300 dark:border-slate-700 hover:border-primary dark:hover:border-primary rounded-2xl transition-all text-left">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">üè∑Ô∏è</span>
                            <h4 class="text-lg font-bold">Nach Themen gruppieren</h4>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400">Reviews nach Topics mit Zusammenfassungen
                        </p>
                    </button>
                </div>
            </section>

            <div id="loading-indicator" class="hidden flex justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            </div>

            <!-- Analysis Results Container (Newly Moved) -->
            <section id="analysis-results-container" class="hidden grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                <!-- Apple Results -->
                <div id="card-apple-insights"
                    class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm p-8 space-y-8">
                    <div
                        class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100 dark:border-slate-800">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üçé</span>
                            <div>
                                <h3 class="font-bold text-lg">Apple Insights</h3>
                                <div id="apple-card-date"
                                    class="text-xs text-slate-500 dark:text-slate-400 font-normal mt-0.5"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div id="apple-card-rating" class="text-right"></div>
                            <button id="btn-copy-apple-insight" title="Karte kopieren"
                                class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800">
                                <span class="material-icons-round">content_copy</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Sentiment √úbersicht
                        </h4>
                        <p id="apple-sentiment" class="text-slate-700 dark:text-slate-300 leading-relaxed italic">
                            Noch keine Analyse vorhanden.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4
                                class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400 font-bold text-sm">
                                <span class="material-icons-round">thumb_up</span> POSITIV
                            </h4>
                            <ul id="apple-pros" class="space-y-3 text-sm"></ul>
                        </div>
                        <div class="space-y-4">
                            <h4 class="flex items-center gap-2 text-red-600 dark:text-red-400 font-bold text-sm">
                                <span class="material-icons-round">thumb_down</span> NEGATIV
                            </h4>
                            <ul id="apple-cons" class="space-y-3 text-sm"></ul>
                        </div>
                    </div>
                </div>

                <!-- Google Results -->
                <div id="card-google-insights"
                    class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm p-8 space-y-8">
                    <div
                        class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100 dark:border-slate-800">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">‚ñ∂Ô∏è</span>
                            <div>
                                <h3 class="font-bold text-lg">Google Insights</h3>
                                <div id="google-card-date"
                                    class="text-xs text-slate-500 dark:text-slate-400 font-normal mt-0.5"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div id="google-card-rating" class="text-right"></div>
                            <button id="btn-copy-google-insight" title="Karte kopieren"
                                class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800">
                                <span class="material-icons-round">content_copy</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Sentiment √úbersicht
                        </h4>
                        <p id="google-sentiment" class="text-slate-700 dark:text-slate-300 leading-relaxed italic">
                            Noch keine Analyse vorhanden.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4
                                class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400 font-bold text-sm">
                                <span class="material-icons-round">thumb_up</span> POSITIV
                            </h4>
                            <ul id="google-pros" class="space-y-3 text-sm"></ul>
                        </div>
                        <div class="space-y-4">
                            <h4 class="flex items-center gap-2 text-red-600 dark:text-red-400 font-bold text-sm">
                                <span class="material-icons-round">thumb_down</span> NEGATIV
                            </h4>
                            <ul id="google-cons" class="space-y-3 text-sm"></ul>
                        </div>
                    </div>
                </div>
            </section>

            <section class="space-y-6">

                <div id="advice-container" class="w-full grid grid-cols-1 lg:grid-cols-2 gap-8"></div>
            </section>

            <section id="reviews-section" class="space-y-6 hidden">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Individuelle Reviews</h3>
                </div>
                <div id="reviews-container" class="space-y-4"></div>
            </section>
        </div>
    </main>

    <!-- Configuration Modal -->
    <div id="config-modal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal(false)"></div>
        <div
            class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Einstellungen</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal(false)">
                        <span class="material-icons-round">close</span>
                    </div>
                </div>

                <div class="my-5">
                    <form id="config-form" class="space-y-4" onsubmit="handleConfigSubmit(event)">
                        <div class="flex space-x-2 bg-slate-100 p-1 rounded-lg">
                            <button type="button" id="tab-app-a" onclick="switchConfigTab('app_a')"
                                class="flex-1 py-1 px-3 rounded-md bg-white shadow-sm text-sm font-medium transition-all">App
                                A</button>
                            <button type="button" id="tab-app-b" onclick="switchConfigTab('app_b')"
                                class="flex-1 py-1 px-3 rounded-md text-slate-500 hover:text-slate-700 text-sm font-medium transition-all">App
                                B</button>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">App Name</label>
                            <input type="text" id="input-app-name"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-slate-700 dark:border-slate-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Apple App
                                ID</label>
                            <input type="text" id="input-app-id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-slate-700 dark:border-slate-600">
                        </div>





                        <hr class="border-slate-200 dark:border-slate-700">

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Gemini API
                                Key</label>
                            <input type="password" id="input-api-key"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div class="pt-4 flex justify-end">
                            <button type="submit"
                                class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800">
                                Speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
        <script type="module">
            // Import from CDN
            import { GoogleGenerativeAI } from "@google/generative-ai";

            // Make it globally available for the rest of the code
            window.GoogleGenerativeAI = GoogleGenerativeAI;
        </script>
        <script>
            // Wait for module to load
            window.addEventListener('load', function () {
                // State
                const state = {
                    apiKey: localStorage.getItem('gemini_api_key') || '',
                    activeAppId: 'app_a',
                    apps: {
                        app_a: {
                            name: localStorage.getItem('appA_name') || 'Visana App',
                            id: localStorage.getItem('appA_id') || '1221367995',
                            dateFrom: localStorage.getItem('appA_dateFrom') || '',
                            dateTo: localStorage.getItem('appA_dateTo') || '',
                            googleFiles: [], // Changed from googleFile to array
                            appleReviews: [],
                            googleReviews: [],
                            insights: { apple: null, google: null },
                            reviewsLoaded: false
                        },
                        app_b: {
                            name: localStorage.getItem('appB_name') || 'myPoints',
                            id: localStorage.getItem('appB_id') || '6745941827',
                            dateFrom: localStorage.getItem('appB_dateFrom') || '',
                            dateTo: localStorage.getItem('appB_dateTo') || '',
                            googleFiles: [], // Changed from googleFile to array
                            appleReviews: [],
                            googleReviews: [],
                            insights: { apple: null, google: null },
                            reviewsLoaded: false
                        }
                    }
                };

                let configEditingApp = 'app_a';

                // Modal Functions - Make global for onclick handlers
                window.toggleModal = function (show) {
                    const modal = document.getElementById('config-modal');
                    if (show) {
                        modal.classList.remove('opacity-0', 'pointer-events-none');
                        document.body.classList.add('modal-active');
                        populateModal();
                    } else {
                        modal.classList.add('opacity-0', 'pointer-events-none');
                        document.body.classList.remove('modal-active');
                    }
                }

                window.switchConfigTab = function (appKey) {
                    configEditingApp = appKey;
                    const tabA = document.getElementById('tab-app-a');
                    const tabB = document.getElementById('tab-app-b');

                    if (appKey === 'app_a') {
                        tabA.classList.add('bg-white', 'shadow-sm');
                        tabA.classList.remove('text-slate-500');
                        tabB.classList.remove('bg-white', 'shadow-sm');
                        tabB.classList.add('text-slate-500');
                    } else {
                        tabB.classList.add('bg-white', 'shadow-sm');
                        tabB.classList.remove('text-slate-500');
                        tabA.classList.remove('bg-white', 'shadow-sm');
                        tabA.classList.add('text-slate-500');
                    }
                    populateModal();
                }

                function populateModal() {
                    const app = state.apps[configEditingApp];
                    document.getElementById('input-app-name').value = app.name;
                    document.getElementById('input-app-id').value = app.id;
                    document.getElementById('input-api-key').value = state.apiKey;
                }

                window.handleConfigSubmit = function (e) {
                    e.preventDefault();
                    console.log('=== CONFIG SUBMIT ===');

                    state.apiKey = document.getElementById('input-api-key').value;
                    const app = state.apps[configEditingApp];
                    app.name = document.getElementById('input-app-name').value;
                    app.id = document.getElementById('input-app-id').value;

                    console.log('Config saved:', {
                        editingApp: configEditingApp,
                        activeApp: state.activeAppId,
                        appName: app.name,
                        appId: app.id,
                        hasApiKey: !!state.apiKey
                    });

                    localStorage.setItem('gemini_api_key', state.apiKey);
                    const appPrefix = configEditingApp === 'app_a' ? 'A' : 'B';
                    localStorage.setItem(`app${appPrefix}_name`, app.name);
                    localStorage.setItem(`app${appPrefix}_id`, app.id);

                    window.toggleModal(false);
                    render();
                }

                // Apple Reviews
                async function fetchAppleReviews(appId, country = 'ch') {
                    const url = `https://itunes.apple.com/${country}/rss/customerreviews/id=${appId}/sortBy=mostRecent/json`;
                    console.log(`Fetching from: ${url}`);

                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                        const data = await response.json();
                        const feed = data.feed;

                        if (!feed || !feed.entry) return [];

                        const entries = Array.isArray(feed.entry) ? feed.entry : [feed.entry];

                        return entries.map(entry => {
                            const author = entry.author?.name?.label || 'Anonymous';
                            const title = entry.title?.label || '';
                            const content = entry.content?.label || '';
                            const rating = parseFloat(entry['im:rating']?.label || '0');
                            const dateStr = entry.updated?.label;
                            const date = dateStr ? new Date(dateStr) : new Date();

                            return { source: 'apple', author, rating, content: title ? `${title}\n${content}` : content, date };
                        });
                    } catch (error) {
                        console.error("Error fetching Apple reviews:", error);
                        return [];
                    }
                }

                // Google CSV Parser
                function parseCSVString(str) {
                    const arr = [];
                    let quote = false, row = [], col = '';

                    for (let c = 0; c < str.length; c++) {
                        let cc = str[c], nc = str[c + 1];

                        if (cc === '"') {
                            if (quote && nc === '"') { col += '"'; c++; }
                            else { quote = !quote; }
                        } else if (cc === ',' && !quote) {
                            row.push(col); col = '';
                        } else if ((cc === '\r' || cc === '\n') && !quote) {
                            row.push(col); col = '';
                            if (row.length > 0) arr.push(row);
                            row = [];
                            if (cc === '\r' && nc === '\n') c++;
                        } else {
                            col += cc;
                        }
                    }
                    if (row.length > 0 || col.length > 0) {
                        row.push(col); arr.push(row);
                    }
                    return arr;
                }

                async function parseGoogleCsv(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const buffer = e.target.result;
                                let content = '';
                                const uint8 = new Uint8Array(buffer);

                                if (uint8[0] === 0xFF && uint8[1] === 0xFE) {
                                    const decoder = new TextDecoder('utf-16le');
                                    content = decoder.decode(uint8.subarray(2));
                                } else {
                                    const decoder = new TextDecoder('utf-8');
                                    content = decoder.decode(uint8);
                                }

                                const rows = parseCSVString(content);
                                if (rows.length === 0) return resolve([]);

                                const headers = rows[0].map(h => h.trim().toLowerCase());
                                const ratingIdx = headers.findIndex(h => h.includes('star rating'));
                                const textIdx = headers.findIndex(h => h.includes('review text'));
                                const titleIdx = headers.findIndex(h => h.includes('review title'));
                                const dateIdx = headers.findIndex(h => h.includes('submit date'));

                                if (ratingIdx === -1) {
                                    console.warn("Invalid Google CSV");
                                    return resolve([]);
                                }

                                const reviews = [];
                                for (let i = 1; i < rows.length; i++) {
                                    const row = rows[i];
                                    if (row.length <= ratingIdx) continue;

                                    const rating = parseFloat(row[ratingIdx]) || 0;
                                    let body = '';
                                    if (textIdx !== -1 && row[textIdx]) body = row[textIdx];
                                    if (titleIdx !== -1 && row[titleIdx]) {
                                        const title = row[titleIdx];
                                        body = body ? `${title}\n${body}` : title;
                                    }
                                    const dateStr = (dateIdx !== -1 && row[dateIdx]) ? row[dateIdx] : null;

                                    reviews.push({
                                        source: 'google',
                                        author: 'Google User',
                                        rating,
                                        content: body || '[No written review]',
                                        date: dateStr ? new Date(dateStr) : new Date()
                                    });
                                }
                                resolve(reviews);
                            } catch (err) {
                                console.error("CSV Parse Error:", err);
                                resolve([]);
                            }
                        };
                        reader.onerror = () => reject(reader.error);
                        reader.readAsArrayBuffer(file);
                    });
                }

                // Gemini
                async function generateInsights(reviews, apiKey) {
                    if (!reviews || reviews.length === 0) {
                        return { sentiment: "Keine Daten.", top_positive: [], top_negative: [], advice: [], verdict: "NEUTRAL" };
                    }
                    if (!apiKey) {
                        return { sentiment: "API Key fehlt.", top_positive: [], top_negative: [], advice: [], verdict: "NEUTRAL" };
                    }

                    try {
                        if (!window.GoogleGenerativeAI) {
                            throw new Error("Google AI SDK nicht geladen. Bitte Seite neu laden.");
                        }
                        const genAI = new window.GoogleGenerativeAI(apiKey);
                        const model = genAI.getGenerativeModel({
                            model: "gemini-3-flash-preview",
                            generationConfig: { responseMimeType: "application/json" }
                        });

                        const prompt = `Analysiere die folgenden App-Bewertungen und gib das Ergebnis NUR als valides JSON zur√ºck.
Erwartetes JSON-Format:
{
    "sentiment": "Zusammenfassung der Stimmung (max 2 S√§tze in Deutsch)",
    "top_positive": ["Punkt 1", "Punkt 2", "Punkt 3"],
    "top_negative": ["Punkt 1", "Punkt 2", "Punkt 3"],
    "advice": ["Rat 1", "Rat 2", "Rat 3"],
    "verdict": "POSITIVE" oder "NEGATIVE" oder "NEUTRAL"
}

Bewertungen:
${reviews.slice(0, 50).map(r => `- [${r.source}] rating: ${r.rating}, content: ${r.content}`).join('\n')}`;

                        const result = await model.generateContent(prompt);
                        const text = result.response.text();
                        const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        return JSON.parse(cleanText);
                    } catch (e) {
                        console.error("Gemini Error:", e);
                        return { sentiment: `Fehler: ${e.message}`, top_positive: [], top_negative: [], advice: [], verdict: "NEUTRAL" };
                    }
                }

                // Filter reviews by date range
                function filterReviewsByDate(reviews, dateFrom, dateTo) {
                    if (!dateFrom && !dateTo) return reviews;

                    const from = dateFrom ? new Date(dateFrom) : null;
                    const to = dateTo ? new Date(dateTo) : null;
                    if (to) to.setHours(23, 59, 59, 999); // Include entire end date

                    console.log(`üìÖ Filtering ${reviews.length} reviews with range: ${dateFrom || 'any'} to ${dateTo || 'any'}`);
                    if (reviews.length > 0) {
                        console.log('Sample review date:', reviews[0].date, 'Type:', typeof reviews[0].date);
                    }

                    const filtered = reviews.filter(review => {
                        const reviewDate = review.date;
                        if (from && reviewDate < from) return false;
                        if (to && reviewDate > to) return false;
                        return true;
                    });

                    console.log(`‚úÇÔ∏è After filtering: ${filtered.length} reviews remaining`);
                    if (filtered.length === 0 && reviews.length > 0) {
                        console.warn('‚ö†Ô∏è All reviews filtered out! Sample dates from original:', reviews.slice(0, 3).map(r => r.date));
                    }

                    return filtered;
                }

                // --- DATA LOADING HANDLERS ---

                async function handleFetchApple() {
                    const currentApp = state.apps[state.activeAppId];
                    if (!currentApp.id) {
                        alert('‚ö†Ô∏è Bitte erst Apple App ID in den Einstellungen konfigurieren!');
                        window.toggleModal(true);
                        return;
                    }

                    const btn = document.getElementById('btn-fetch-apple');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-slate-600"></div> Laden...`;
                    btn.disabled = true;

                    try {
                        console.log('Fetching Apple reviews...');
                        currentApp.appleReviews = await fetchAppleReviews(currentApp.id);
                        console.log('Apple reviews fetched:', currentApp.appleReviews.length);

                        // Update badge
                        document.getElementById('apple-verdict-badge').innerHTML =
                            `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${currentApp.appleReviews.length} Reviews</span>`;

                        // Check if we can enable analysis controls
                        updateAnalysisControlsVisibility();

                        render(); // Update reviews list immediately
                        alert(`‚úÖ ${currentApp.appleReviews.length} Apple Reviews geladen!`);
                    } catch (error) {
                        console.error('Error fetching Apple reviews:', error);
                        alert('Fehler beim Laden der Apple Reviews: ' + error.message);
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }

                function handleUploadGoogle() {
                    document.getElementById('input-google-csv-card').click();
                }

                async function handleGoogleFileSelect(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;

                    const currentApp = state.apps[state.activeAppId];
                    const btn = document.getElementById('btn-upload-google');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-slate-600"></div> Laden...`;
                    btn.disabled = true;

                    try {
                        console.log('Parsing Google CSV files...');
                        currentApp.googleReviews = [];

                        for (const file of files) {
                            console.log(`  üìÑ Parsing ${file.name}...`);
                            const reviews = await parseGoogleCsv(file);
                            console.log(`  ‚úÖ Parsed ${reviews.length} reviews from ${file.name}`);
                            currentApp.googleReviews.push(...reviews);
                        }

                        // Update badge
                        document.getElementById('google-verdict-badge').innerHTML =
                            `<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">${currentApp.googleReviews.length} Reviews</span>`;

                        // Check if we can enable analysis controls
                        updateAnalysisControlsVisibility();

                        render(); // Update reviews list immediately
                        alert(`‚úÖ ${currentApp.googleReviews.length} Google Reviews geladen!`);
                    } catch (error) {
                        console.error('Error parsing Google CSV:', error);
                        alert('Fehler beim Laden der CSV Datei: ' + error.message);
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        // Reset input so same file can be selected again if needed
                        event.target.value = '';
                    }
                }

                function updateAnalysisControlsVisibility() {
                    const currentApp = state.apps[state.activeAppId];
                    const hasReviews = (currentApp.appleReviews && currentApp.appleReviews.length > 0) ||
                        (currentApp.googleReviews && currentApp.googleReviews.length > 0);

                    const controls = document.getElementById('analysis-date-controls');
                    const modeSelector = document.getElementById('analysis-mode-selector');

                    if (hasReviews) {
                        controls.classList.remove('hidden');
                        modeSelector.classList.remove('hidden');
                        currentApp.reviewsLoaded = true; // Flag for legacy checks

                        // Hide results if data changes (forcing re-analysis)
                        document.getElementById('analysis-results-container').classList.add('hidden');
                    }
                }

                // Helper to get date date ranges for validation
                function getAvailableDateRange(reviews) {
                    if (!reviews || reviews.length === 0) return null;
                    const dates = reviews.map(r => r.date).sort((a, b) => a - b);
                    return {
                        min: dates[0],
                        max: dates[dates.length - 1]
                    };
                }

                // Helper to validate selected range against available data
                function validateDateRange(selectedFrom, selectedTo) {
                    const currentApp = state.apps[state.activeAppId];
                    const warnings = [];

                    if (selectedFrom && selectedTo && selectedFrom > selectedTo) {
                        warnings.push("‚ö†Ô∏è 'Von' Datum darf nicht nach 'Bis' Datum sein.");
                    }

                    // Check Apple Range
                    if (currentApp.appleReviews && currentApp.appleReviews.length > 0) {
                        const appleRange = getAvailableDateRange(currentApp.appleReviews);
                        if (appleRange) {
                            if (selectedFrom && new Date(selectedFrom) < appleRange.min) {
                                warnings.push(`‚ö†Ô∏è Apple Reviews erst verf√ºgbar ab ${appleRange.min.toLocaleDateString('de-CH')}.`);
                            }
                            if (selectedTo && new Date(selectedTo) > appleRange.max) {
                                warnings.push(`‚ö†Ô∏è Apple Reviews nur verf√ºgbar bis ${appleRange.max.toLocaleDateString('de-CH')}.`);
                            }
                        }
                    }

                    // Check Google Range
                    if (currentApp.googleReviews && currentApp.googleReviews.length > 0) {
                        const googleRange = getAvailableDateRange(currentApp.googleReviews);
                        if (googleRange) {
                            if (selectedFrom && new Date(selectedFrom) < googleRange.min) {
                                warnings.push(`‚ö†Ô∏è Google Reviews erst verf√ºgbar ab ${googleRange.min.toLocaleDateString('de-CH')}.`);
                            }
                            if (selectedTo && new Date(selectedTo) > googleRange.max) {
                                warnings.push(`‚ö†Ô∏è Google Reviews nur verf√ºgbar bis ${googleRange.max.toLocaleDateString('de-CH')}.`);
                            }
                        }
                    }

                    const warningContainer = document.getElementById('date-range-warnings');
                    if (warnings.length > 0) {
                        warningContainer.innerHTML = warnings.join('<br>');
                        warningContainer.classList.remove('hidden');
                    } else {
                        warningContainer.classList.add('hidden');
                    }
                }



                // Analysis Functions - called after data is loaded
                // Analysis Functions - called after data is loaded
                async function generateInsightsMode() {
                    const currentApp = state.apps[state.activeAppId];

                    if (!currentApp.reviewsLoaded) {
                        alert('‚ö†Ô∏è Bitte laden Sie zuerst die Daten!');
                        return;
                    }

                    if (!state.apiKey) {
                        alert('‚ö†Ô∏è Bitte konfigurieren Sie zuerst Ihren Gemini API Key!');
                        return;
                    }

                    // Get Date Range
                    const dateFrom = document.getElementById('analysis-date-from').value ? new Date(document.getElementById('analysis-date-from').value) : null;
                    const dateTo = document.getElementById('analysis-date-to').value ? new Date(document.getElementById('analysis-date-to').value) : null;

                    // Filter Reviews
                    currentApp.filteredApple = filterReviewsByDate(currentApp.appleReviews, dateFrom, dateTo);
                    currentApp.filteredGoogle = filterReviewsByDate(currentApp.googleReviews, dateFrom, dateTo);

                    if (currentApp.filteredApple.length === 0 && currentApp.filteredGoogle.length === 0) {
                        alert('‚ö†Ô∏è Keine Reviews im gew√§hlten Zeitraum!');
                        return;
                    }

                    document.getElementById('loading-indicator').classList.remove('hidden');
                    document.getElementById('dashboard-content').classList.add('opacity-50');

                    try {
                        // Generate insights for filtered reviews
                        if (currentApp.filteredApple && currentApp.filteredApple.length > 0) {
                            console.log('Generating Apple insights...');
                            currentApp.insights.apple = await generateInsights(currentApp.filteredApple, state.apiKey);
                        } else {
                            currentApp.insights.apple = null;
                        }

                        if (currentApp.filteredGoogle && currentApp.filteredGoogle.length > 0) {
                            console.log('Generating Google insights...');
                            currentApp.insights.google = await generateInsights(currentApp.filteredGoogle, state.apiKey);
                        } else {
                            currentApp.insights.google = null;
                        }

                        // Show Insights
                        document.getElementById('analysis-results-container').classList.remove('hidden'); // Show New Container
                        render();
                    } catch (error) {
                        console.error('Error generating insights:', error);
                        alert('Fehler bei der Analyse: ' + error.message);
                    } finally {
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('dashboard-content').classList.remove('opacity-50');
                    }
                }

                async function generateTopicsMode() {
                    const currentApp = state.apps[state.activeAppId];

                    if (!currentApp.reviewsLoaded) {
                        alert('‚ö†Ô∏è Bitte laden Sie zuerst die Daten!');
                        return;
                    }

                    if (!state.apiKey) {
                        alert('‚ö†Ô∏è Bitte konfigurieren Sie zuerst Ihren Gemini API Key!');
                        return;
                    }

                    // Get Date Range
                    const dateFrom = document.getElementById('analysis-date-from').value ? new Date(document.getElementById('analysis-date-from').value) : null;
                    const dateTo = document.getElementById('analysis-date-to').value ? new Date(document.getElementById('analysis-date-to').value) : null;

                    // Filter Reviews
                    currentApp.filteredApple = filterReviewsByDate(currentApp.appleReviews, dateFrom, dateTo);
                    currentApp.filteredGoogle = filterReviewsByDate(currentApp.googleReviews, dateFrom, dateTo);

                    document.getElementById('loading-indicator').classList.remove('hidden');
                    document.getElementById('dashboard-content').classList.add('opacity-50');

                    try {
                        // Combine all reviews
                        const allReviews = [
                            ...(currentApp.filteredApple || []),
                            ...(currentApp.filteredGoogle || [])
                        ];

                        if (allReviews.length === 0) {
                            alert('‚ö†Ô∏è Keine Reviews zum Gruppieren!');
                            return;
                        }

                        // Call Gemini for topic grouping
                        const topicsResult = await generateTopicGrouping(allReviews, state.apiKey);
                        currentApp.topics = topicsResult;

                        // Show topics
                        renderTopics();
                    } catch (error) {
                        console.error('Error generating topics:', error);
                        alert('Fehler bei der Themen-Analyse: ' + error.message);
                    } finally {
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('dashboard-content').classList.remove('opacity-50');
                    }
                }

                async function generateTopicGrouping(reviews, apiKey) {
                    const { GoogleGenerativeAI } = await import('https://esm.run/@google/generative-ai');
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

                    const prompt = `Analysiere diese App-Reviews und gruppiere sie nach Themen.
Antworte auf DEUTSCH.

Reviews k√∂nnen in MEHREREN Themen erscheinen, wenn relevant.

Gib JSON in exakt diesem Format zur√ºck:
{
    "topics": [
        {
            "title": "Kurzer Titel des Themas (auf Deutsch)",
            "review_indices": [Array von Review-Indices die zu diesem Thema geh√∂ren],
            "summary": "Kurze Zusammenfassung des Inhalts (auf Deutsch)",
            "sentiment": "POSITIVE|NEUTRAL|NEGATIVE",
            "os_specificity": "iOS|Android|Both"
        }
    ]
}

Reviews:
${reviews.map((r, i) => `[${i}] (${r.source.toUpperCase()}) ${r.rating}‚≠ê ${r.author}: ${r.content.substring(0, 200)}...`).join('\n\n')}

Antworte nur mit validem JSON, kein Markdown.`;

                    const result = await model.generateContent(prompt);
                    const text = result.response.text();
                    const cleaned = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    return JSON.parse(cleaned);
                }

                // Rendering
                function render() {
                    console.log('=== RENDER START ===');
                    const app = state.apps[state.activeAppId];
                    console.log('Rendering app:', app.name, 'Insights:', app.insights);

                    document.getElementById('header-title').innerText = `Analyse: ${app.name}`;
                    document.getElementById('label-app-a-name').innerText = state.apps.app_a.name;
                    document.getElementById('label-app-b-name').innerText = state.apps.app_b.name;

                    updateExportButtonVisibility(); // Update buttons based on state



                    // Show/hide analysis mode selector
                    const analysisModeSelector = document.getElementById('analysis-mode-selector');
                    const hasInsights = app.insights.apple || app.insights.google;
                    const hasTopics = app.topics;

                    if (app.reviewsLoaded) {
                        analysisModeSelector.classList.remove('hidden');
                    } else {
                        analysisModeSelector.classList.add('hidden');
                    }



                    // Update Review Count Badges (if no verdict yet)
                    if (!app.insights.apple && app.appleReviews && app.appleReviews.length > 0) {
                        document.getElementById('apple-verdict-badge').innerHTML =
                            `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${app.appleReviews.length} Reviews</span>`;
                    } else if (!app.insights.apple) {
                        document.getElementById('apple-verdict-badge').innerHTML = '';
                    }

                    if (!app.insights.google && app.googleReviews && app.googleReviews.length > 0) {
                        document.getElementById('google-verdict-badge').innerHTML =
                            `<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">${app.googleReviews.length} Reviews</span>`;
                    } else if (!app.insights.google) {
                        document.getElementById('google-verdict-badge').innerHTML = '';
                    }

                    // Show/hide reviews and advice based on state

                    const btnA = document.getElementById('btn-select-app-a');
                    const btnB = document.getElementById('btn-select-app-b');
                    if (state.activeAppId === 'app_a') {
                        btnA.classList.add('bg-slate-100', 'dark:bg-slate-800', 'font-semibold');
                        btnB.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'font-semibold');
                    } else {
                        btnB.classList.add('bg-slate-100', 'dark:bg-slate-800', 'font-semibold');
                        btnA.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'font-semibold');
                    }

                    renderCard('apple', app.insights.apple);
                    renderCard('google', app.insights.google);

                    // Separate advice for iOS and Android
                    const appleAdvice = app.insights.apple?.advice || [];
                    const googleAdvice = app.insights.google?.advice || [];

                    let adviceHTML = '';

                    if (appleAdvice.length > 0) {
                        adviceHTML += `
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 col-span-full">
                                <span class="text-2xl">üçé</span>
                                Handlungsempfehlung iOS
                            </h3>
                        `;
                        appleAdvice.forEach(a => {
                            adviceHTML += `
                                <div class="p-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl">
                                    <div class="w-10 h-10 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg flex items-center justify-center mb-4">
                                        <span class="material-icons-round">campaign</span>
                                    </div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">${a}</p>
                                </div>
                            `;
                        });
                    }

                    if (googleAdvice.length > 0) {
                        adviceHTML += `
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 col-span-full">
                                <span class="text-2xl">‚ñ∂Ô∏è</span>
                                Handlungsempfehlung Android
                            </h3>
                        `;
                        googleAdvice.forEach(a => {
                            adviceHTML += `
                                <div class="p-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl">
                                    <div class="w-10 h-10 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 rounded-lg flex items-center justify-center mb-4">
                                        <span class="material-icons-round">campaign</span>
                                    </div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">${a}</p>
                                </div>
                            `;
                        });
                    }

                    document.getElementById('advice-container').innerHTML = adviceHTML;

                    // Filter Reviews for Display
                    const dateFrom = document.getElementById('analysis-date-from').value ? new Date(document.getElementById('analysis-date-from').value) : null;
                    const dateTo = document.getElementById('analysis-date-to').value ? new Date(document.getElementById('analysis-date-to').value) : null;

                    const filteredApple = filterReviewsByDate(app.appleReviews, dateFrom, dateTo);
                    const filteredGoogle = filterReviewsByDate(app.googleReviews, dateFrom, dateTo);

                    // Update Stats

                    // Update Card Header Stats (Date + Big Rating)
                    const formatDate = (d) => d ? d.toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                    const dateStr = (dateFrom && dateTo) ? `${formatDate(dateFrom)} - ${formatDate(dateTo)}` : 'Gesamter Zeitraum';

                    // Update Dates
                    if (document.getElementById('apple-card-date')) document.getElementById('apple-card-date').innerText = dateStr;
                    if (document.getElementById('google-card-date')) document.getElementById('google-card-date').innerText = dateStr;

                    const updateCardRating = (reviews, elId) => {
                        const el = document.getElementById(elId);
                        if (!el) return;

                        if (!reviews || reviews.length === 0) {
                            el.innerHTML = '<span class="text-xs text-slate-400">Keine Daten</span>';
                            return;
                        }

                        const avg = (reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length).toFixed(1);

                        el.innerHTML = `
                            <div class="flex items-center justify-end gap-1 text-2xl font-bold text-slate-900 dark:text-white">
                                ${avg} <span class="material-icons-round text-amber-500 text-2xl">star</span>
                            </div>
                            <div class="text-xs text-slate-400">${reviews.length} Reviews</div>
                         `;
                    };

                    updateCardRating(filteredApple, 'apple-card-rating');
                    updateCardRating(filteredGoogle, 'google-card-rating');
                    const updateStat = (id, reviews) => {
                        const el = document.getElementById(id);
                        if (!reviews || reviews.length === 0) {
                            el.innerHTML = `${id.includes('apple') ? 'üçé' : '‚ñ∂Ô∏è'} <span class="font-bold">-</span> √ò`;
                            return;
                        }
                        const avg = (reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length).toFixed(1);
                        el.innerHTML = `${id.includes('apple') ? 'üçé' : '‚ñ∂Ô∏è'} <span class="font-bold">${avg}</span> √ò (${reviews.length})`;
                    };
                    updateStat('stats-apple', filteredApple);
                    updateStat('stats-google', filteredGoogle);

                    const recentReviews = [...filteredApple, ...filteredGoogle]
                        .sort((a, b) => b.date - a.date);

                    document.getElementById('reviews-container').innerHTML = recentReviews.map(r => `
        <div class="p-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-400">
                        <span class="material-icons-round">person</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                             <span class="font-bold">${r.author}</span>
                             <span class="text-xs px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 uppercase">${r.source}</span>
                        </div>
                        <div class="flex text-amber-400 text-sm">
                            ${Array(5).fill(0).map((_, i) => `<span class="material-icons-round text-base">${i < r.rating ? 'star' : 'star_border'}</span>`).join('')}
                        </div>
                    </div>
                </div>
                <span class="text-xs text-slate-400 font-medium">${r.date.toLocaleDateString()}</span>
            </div>
            <p class="text-slate-700 dark:text-slate-300 leading-relaxed">${r.content.replace(/\n/g, '<br>')}</p>
        </div>
                `).join('');

                    // Reset header
                    document.getElementById('reviews-container').previousElementSibling.querySelector('h3').innerText = "Individuelle Reviews";

                    // Show/Hide Reviews Section
                    const reviewsSection = document.getElementById('reviews-section');
                    if (document.getElementById('reviews-container').innerHTML.trim() !== "") {
                        reviewsSection.classList.remove('hidden');
                    } else {
                        reviewsSection.classList.add('hidden');
                    }
                }

                function renderCard(platform, insights) {
                    console.log(`Rendering ${platform} card:`, insights);
                    if (!insights) {
                        console.warn(`No insights for ${platform}, skipping render`);
                        return;
                    }

                    const verdict = document.getElementById(`${platform}-verdict-badge`);
                    const sentiment = document.getElementById(`${platform}-sentiment`);
                    const pros = document.getElementById(`${platform}-pros`);
                    const cons = document.getElementById(`${platform}-cons`);

                    const isNeg = insights.verdict === 'NEGATIVE';
                    const color = isNeg ? 'red' : (insights.verdict === 'POSITIVE' ? 'emerald' : 'gray');

                    verdict.className = `px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-1 bg-${color}-100 dark:bg-${color}-900/30 text-${color}-700 dark:text-${color}-400`;
                    verdict.innerHTML = `<span class="material-icons-round text-sm">${isNeg ? 'trending_down' : 'trending_up'}</span> ${insights.verdict}`;

                    sentiment.innerHTML = insights.sentiment;
                    pros.innerHTML = insights.top_positive.map(p => `<li class="flex gap-2 text-slate-600 dark:text-slate-400"><span class="text-emerald-500">‚Ä¢</span> ${p}</li>`).join('');
                    cons.innerHTML = insights.top_negative.map(p => `<li class="flex gap-2 text-slate-600 dark:text-slate-400"><span class="text-red-500">‚Ä¢</span> ${p}</li>`).join('');
                }

                function renderTopics() {
                    console.log('Rendering topics...');
                    const app = state.apps[state.activeAppId];
                    const container = document.getElementById('reviews-container');

                    if (!app.topics || !app.topics.topics) {
                        return;
                    }

                    // Get Date Range
                    const dateFrom = document.getElementById('analysis-date-from').value ? new Date(document.getElementById('analysis-date-from').value) : null;
                    const dateTo = document.getElementById('analysis-date-to').value ? new Date(document.getElementById('analysis-date-to').value) : null;
                    const formatDate = (d) => d ? d.toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                    const dateStr = (dateFrom && dateTo) ? `${formatDate(dateFrom)} - ${formatDate(dateTo)}` : 'Gesamter Zeitraum';

                    // Show topics in reviews container
                    let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;

                    app.topics.topics.forEach((topic, i) => {
                        const sentimentColor = topic.sentiment === 'POSITIVE' ? 'emerald' : (topic.sentiment === 'NEGATIVE' ? 'red' : 'slate');
                        const osBadge = topic.os_specificity === 'iOS' ? 'üçé iOS' : (topic.os_specificity === 'Android' ? '‚ñ∂Ô∏è Android' : 'üì± Beide');

                        html += `
                            <div id="topic-card-${i}" class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-grow pr-4">
                                        <h3 class="font-bold text-lg text-slate-900 dark:text-white leading-tight">${topic.title}</h3>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 font-normal mt-1">${dateStr}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-1 bg-${sentimentColor}-100 dark:bg-${sentimentColor}-900/30 text-${sentimentColor}-700 dark:text-${sentimentColor}-400 text-xs rounded-full font-bold">
                                            ${topic.sentiment}
                                        </span>
                                        <button class="btn-copy-topic text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800" data-card-id="topic-card-${i}" title="Karte kopieren">
                                            <span class="material-icons-round">content_copy</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-4 flex items-center gap-2">
                                    <span class="text-xs font-medium px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-slate-600 dark:text-slate-400">
                                        ${osBadge}
                                    </span>
                                </div>
                                <p class="text-slate-600 dark:text-slate-300 text-sm mb-4 leading-relaxed">
                                    ${topic.summary}
                                </p>
                                <div class="space-y-3 pt-4 border-t border-slate-100 dark:border-slate-800">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Beispiel-Reviews:</h4>
                                    ${topic.review_indices.slice(0, 3).map(idx => {
                            // Find review in filtered lists
                            // Note: Review indices in topics match the array passed to Gemini
                            const allReviews = [...(app.filteredApple || []), ...(app.filteredGoogle || [])];
                            const r = allReviews[idx];
                            if (!r) return '';
                            return `
                                            <div class="text-xs p-2 bg-slate-50 dark:bg-slate-800/50 rounded border border-slate-100 dark:border-slate-800/50">
                                                <div class="flex justify-between mb-1 text-slate-400">
                                                    <span>${r.author}</span>
                                                    <span>${r.rating}‚≠ê</span>
                                                </div>
                                                <p class="text-slate-700 dark:text-slate-300 italic">"${r.content.substring(0, 100)}${r.content.length > 100 ? '...' : ''}"</p>
                                            </div>
                                        `;
                        }).join('')}
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;

                    // Update header
                    document.getElementById('reviews-container').innerHTML = html;
                    document.getElementById('reviews-container').previousElementSibling.querySelector('h3').innerText = `Themen-Cluster (${app.topics.topics.length})`;
                    updateExportButtonVisibility();
                }

                function updateExportButtonVisibility() {
                    const app = state.apps[state.activeAppId];
                    const hasInsights = app.insights.apple || app.insights.google; // Check for any insight content
                    const hasTopics = app.topics;

                    const btnExportInsights = document.getElementById('btn-export-img-insights');
                    const btnExportTopics = document.getElementById('btn-export-img-topics');

                    if (hasInsights) btnExportInsights.classList.remove('hidden');
                    else btnExportInsights.classList.add('hidden');

                    if (hasTopics) btnExportTopics.classList.remove('hidden');
                    else btnExportTopics.classList.add('hidden');
                }

                // Initialize - runs when everything is loaded
                document.getElementById('btn-insights-mode').onclick = () => generateInsightsMode();
                document.getElementById('btn-topics-mode').onclick = () => generateTopicsMode();

                document.getElementById('btn-select-app-a').onclick = () => { state.activeAppId = 'app_a'; render(); updateAnalysisControlsVisibility(); };
                document.getElementById('btn-select-app-b').onclick = () => { state.activeAppId = 'app_b'; render(); updateAnalysisControlsVisibility(); };

                // New Handlers
                document.getElementById('btn-fetch-apple').onclick = handleFetchApple;
                const btnUploadGoogle = document.getElementById('btn-upload-google');
                if (btnUploadGoogle) btnUploadGoogle.onclick = handleUploadGoogle;

                const inputGoogleCard = document.getElementById('input-google-csv-card');
                if (inputGoogleCard) inputGoogleCard.onchange = handleGoogleFileSelect;

                // Image Export Handlers
                async function captureElements(elements, filename) {
                    const btn = document.activeElement; // To restore focus/state if needed
                    const originalText = btn ? btn.innerText : '';
                    if (btn) btn.innerText = '‚è≥';

                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'absolute';
                    wrapper.style.left = '-9999px';
                    wrapper.style.top = '0';
                    wrapper.style.width = '1200px';
                    wrapper.style.backgroundColor = document.documentElement.classList.contains('dark') ? '#0F172A' : '#F8FAFC';
                    wrapper.style.padding = '40px';
                    wrapper.style.zIndex = '9999';

                    // Header
                    const header = document.createElement('h2');
                    header.innerText = "ReviewAI Report";
                    header.style.fontFamily = 'sans-serif';
                    header.style.marginBottom = '20px';
                    header.style.fontSize = '24px';
                    header.style.fontWeight = 'bold';
                    header.style.color = document.documentElement.classList.contains('dark') ? '#fff' : '#0F172A';
                    wrapper.appendChild(header);

                    // Add elements
                    elements.forEach(el => {
                        if (el && !el.classList.contains('hidden')) {
                            // Clone deeply
                            const clone = el.cloneNode(true);

                            // Clean up clone styles for static export
                            clone.style.margin = '0 0 40px 0';
                            clone.style.transform = 'none';
                            clone.style.transition = 'none';

                            // Ensure text colors are right (Tailwind dark mode relies on class on parent)
                            if (document.documentElement.classList.contains('dark')) {
                                clone.classList.add('dark');
                            }

                            wrapper.appendChild(clone);
                        }
                    });

                    document.body.appendChild(wrapper);

                    try {
                        // Wait a tick for rendering
                        await new Promise(r => setTimeout(r, 100));

                        const canvas = await html2canvas(wrapper, {
                            backgroundColor: document.documentElement.classList.contains('dark') ? '#0F172A' : '#F8FAFC',
                            scale: 2,
                            useCORS: true,
                            logging: false
                        });

                        canvas.toBlob(blob => {
                            try {
                                const item = new ClipboardItem({ "image/png": blob });
                                navigator.clipboard.write([item]);
                                alert("‚úÖ Bild in die Zwischenablage kopiert!");
                            } catch (err) {
                                console.error("Clipboard export failed", err);
                                alert("Kopieren fehlgeschlagen: " + err.message);
                            }
                        });
                    } catch (err) {
                        console.error("Export failed", err);
                        alert("Export fehlgeschlagen: " + err.message);
                    } finally {
                        document.body.removeChild(wrapper);
                        if (btn) btn.innerHTML = originalText; // Restore button content (icon logic might be lost, simplified here)
                        // Actually, my buttons have icons. restoring innerText wipes html. 
                        // Better: don't change text or restore innerHTML.
                        // Let's just not change text for now to be safe.
                        if (btn) btn.innerHTML = originalText;
                    }
                }

                document.getElementById('btn-export-img-insights').onclick = function () {
                    const btn = this;
                    const oldHTML = btn.innerHTML;
                    btn.innerHTML = '<span class="animate-spin">‚è≥</span>'; // Simple loading feedback

                    setTimeout(() => {
                        captureElements([
                            document.getElementById('analysis-date-controls'),
                            document.getElementById('analysis-results-container'),
                            document.getElementById('advice-container')
                        ], `ReviewAI_Insights`).then(() => btn.innerHTML = oldHTML);
                    }, 50);
                };

                document.getElementById('btn-export-img-topics').onclick = function () {
                    const btn = this;
                    const oldHTML = btn.innerHTML;
                    btn.innerHTML = '<span class="animate-spin">‚è≥</span>';

                    setTimeout(() => {
                        captureElements([
                            document.getElementById('analysis-date-controls'),
                            document.getElementById('reviews-section')
                        ], `ReviewAI_Topics`).then(() => btn.innerHTML = oldHTML);
                    }, 50);
                };

                // Individual Card Copy Handlers
                if (document.getElementById('btn-copy-apple-insight')) {
                    document.getElementById('btn-copy-apple-insight').onclick = function () {
                        const btn = this;
                        const oldHTML = btn.innerHTML;
                        btn.innerHTML = '<span class="animate-spin text-sm">‚è≥</span>';
                        setTimeout(() => {
                            captureElements([document.getElementById('card-apple-insights')], 'Apple_Insights')
                                .then(() => btn.innerHTML = oldHTML);
                        }, 50);
                    }
                }

                if (document.getElementById('btn-copy-google-insight')) {
                    document.getElementById('btn-copy-google-insight').onclick = function () {
                        const btn = this;
                        const oldHTML = btn.innerHTML;
                        btn.innerHTML = '<span class="animate-spin text-sm">‚è≥</span>';
                        setTimeout(() => {
                            captureElements([document.getElementById('card-google-insights')], 'Google_Insights')
                                .then(() => btn.innerHTML = oldHTML);
                        }, 50);
                    }
                }

                // Topic Card Copy Handlers (Delegation for dynamic elements)
                document.addEventListener('click', function (e) {
                    const btn = e.target.closest('.btn-copy-topic');
                    if (btn) {
                        const cardId = btn.getAttribute('data-card-id');
                        const oldHTML = btn.innerHTML;
                        btn.innerHTML = '<span class="animate-spin text-sm">‚è≥</span>';
                        setTimeout(() => {
                            const card = document.getElementById(cardId);
                            if (card) {
                                captureElements([card], 'Topic_Cluster')
                                    .then(() => btn.innerHTML = oldHTML);
                            }
                        }, 50);
                    }
                });

                // Date Validation Handlers
                const updateValidation = () => {
                    const from = document.getElementById('analysis-date-from').value;
                    const to = document.getElementById('analysis-date-to').value;
                    validateDateRange(from ? new Date(from) : null, to ? new Date(to) : null);
                    render(); // Live update list
                };
                document.getElementById('analysis-date-from').onchange = updateValidation;
                document.getElementById('analysis-date-to').onchange = updateValidation;


                document.getElementById('btn-export-csv').onclick = () => {
                    const app = state.apps[state.activeAppId];
                    const allReviews = [...app.appleReviews, ...app.googleReviews];

                    if (allReviews.length === 0) {
                        alert('Keine Reviews zum Exportieren vorhanden.');
                        return;
                    }

                    // CSV Header
                    let csv = 'Date,OS,Username,Rating,Text\n';

                    // CSV Rows
                    allReviews.forEach(review => {
                        const date = review.date.toISOString().split('T')[0]; // YYYY-MM-DD
                        const os = review.source === 'apple' ? 'iOS' : 'Android';
                        const username = `"${(review.author || '').replace(/"/g, '""')}"`; // Escape quotes
                        const rating = review.rating;
                        const text = `"${(review.content || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`; // Escape quotes and newlines

                        csv += `${date},${os},${username},${rating},${text}\n`;
                    });

                    // Create download
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${app.name.replace(/\s+/g, '_')}_Reviews_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);

                    console.log(`Exported ${allReviews.length} reviews to CSV`);
                };

                document.getElementById('btn-header-settings').onclick = () => window.toggleModal(true);

                // Set default date range (Last 14 days)
                const today = new Date();
                const last14Days = new Date();
                last14Days.setDate(today.getDate() - 14);

                document.getElementById('analysis-date-to').value = today.toISOString().split('T')[0];
                document.getElementById('analysis-date-from').value = last14Days.toISOString().split('T')[0];

                render();
                if (!state.apiKey) {
                    window.toggleModal(true);
                }
                // No auto loadData() anymore

            }); // End window.addEventListener('load')
        </script>
</body>

</html>